WIP.

### STATUS:
Todo:
- Update Dockerfiles in master branches of all GIT repo
- Mount CMS frontend

Dockerfiles and docker compose working for DEV machine.

A collection of subrepo's of the main servers of the Openstad application.

Currently dockerfiles or not in the master branches of the included repo's so will not work out of the box.

Since this repo is working with subrepo's make sure you pull all of them first time, for instance:

```
git submodule update --init --recursive
```

## Create .env file before starting docker-compose
Firstcreate the .env before running docker-compose the first time. On first startup docker compose will create the databases, changes after first startup  you have to manually do them by logging into mysql through shell or a db tool like sqlpro, or just destroy the database volumes and start over. This step only makes sure the databases exists, the tables filling the databases are created in the next step.

Create a .env file based upon the .env for development, put it in the root next to docker-compose. This will run the CMS as http://localhost:4444/. Login token will be generated by following env value: AUTH_FIRST_CLIENT_LOGIN_CODE



## Start up docker compose
For development install and start docker desktop.

```
docker-compose up --d
```


## Running migrations and seeds
For now, for dev, the migrations have to be run manually.

There are a few settings in the databases that need to be set correctly for it all
to work together. This works in combination with above .env values.
Any changes in .env values after running the seeds might require database changes.


1. Create the api site entries (runs both basic migrations and seeds.). . This seed run will empty the tables, so don't use once running.
```
docker-compose exec api node reset.js
```

2.1 Create the tables for the Auth server
```
docker-compose exec auth knex migrate:latest
```

2.2 Seed the table for the Auth server. . This seed run will empty the tables, so don't use once running.
```
docker-compose exec auth knex seed:run
```

3.1 Create the tables for the Image server
```
docker-compose exec image knex migrate:latest
```

3.2 Seed the tables for the Image server. This seed run will empty the tables, so don't use once running.
```
docker-compose exec image knex seed:run
```

## Basic auth Login

There is a basic auth in the CMS login flow, will be removed soon but untill then, credentials are managed by the following env file:

```
FRONTEND_LOGIN_CSM_BASIC_AUTH_USER=me
FRONTEND_LOGIN_CSM_BASIC_AUTH_PASSWORD=password
```

## Mysql
Docker compose creates the databases set in .env file on first run.
If name is changed you will either have to recreate the mysql volume, or manually change or add the database.
Port 3310 is open, so you can access docker database on http://localhost:3310, for instance with sqlpro.
Or log into the docker shell: docker-compose exec mysql sh

## Reloading .env values
docker-compose doesn't always seem to reload env values if you change the .env file.

To force it:

For all containers:
docker-compose up --force-recreate

For one container
docker-compose up --force-recreate frontend
